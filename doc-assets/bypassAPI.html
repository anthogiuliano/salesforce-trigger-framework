<h1 class="code-line" data-line-start="0" data-line-end="1"><a id="Salesforce_Trigger_Framework_0"></a>Salesforce Trigger Framework</h1>
<h2 class="code-line" data-line-start="2" data-line-end="3"><a id="Credit_2"></a>Credit</h2>
<p class="has-line-data" data-line-start="4" data-line-end="5">
	Based on Kevin O’Hara’s famous framework <a href="https://github.com/kevinohara80/sfdc-trigger-framework">sfdc-trigger-framework</a>
</p>
<h2 class="code-line" data-line-start="10" data-line-end="11"><a id="Overview_10"></a>Overview</h2>
<p class="has-line-data" data-line-start="12" data-line-end="13">
	Triggers should be logicless. Putting logic into your triggers creates un-testable, difficult-to-maintain code. It’s widely accepted that a best-practice is to move trigger logic
	into a handler class.
</p>
<p class="has-line-data" data-line-start="14" data-line-end="15">
	This trigger framework bundles a single <strong>TriggerHandler</strong> base class that you can inherit from in all of your trigger handlers. The base class includes
	context-specific methods that are automatically called when a trigger is executed.
</p>
<p class="has-line-data" data-line-start="16" data-line-end="17">
	The base class also provides a secondary role as a supervisor for Trigger execution. It acts like a watchdog, monitoring trigger activity and providing an api for controlling
	certain aspects of execution and control flow.
</p>
<p class="has-line-data" data-line-start="18" data-line-end="19">But the most important part of this framework is that it’s minimal and simple to use.</p>
<p>See the sample handler documentation at <a href="triggerhandlerhome.html">TriggerHandler</a>.</p>

<h2 class="code-line" data-line-start="26" data-line-end="27"><a id="Usage_26"></a>Usage</h2>
<p class="has-line-data" data-line-start="28" data-line-end="29">
	To create a trigger handler, you simply need to create a class that inherits from <strong><a href="./TriggerHandler.html">TriggerHandler</a></strong
	>. Here is an example for creating an Opportunity trigger handler.
</p>
<!--
<pre><code class="has-line-data" data-line-start="31" data-line-end="33" class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpportunityTriggerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TriggerHandler</span> </span>{
</code></pre>

<p class="has-line-data" data-line-start="34" data-line-end="35">
	In your trigger handler, to add logic to any of the trigger contexts, you only need to override them in your trigger handler. Here is how we would add logic to a
	<code>beforeUpdate</code> trigger.
</p>
<pre><code class="has-line-data" data-line-start="37" data-line-end="54" class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpportunityTriggerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TriggerHandler</span> </span>{<br />
	<br />
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OpportunityTriggerHandler</span><span class="hljs-params">()</span></span>{<br />
      <span class="hljs-comment">/* Optional Constructor overload - better performance */</span><br />
      <span class="hljs-keyword">super</span>(<span class="hljs-string">'OpportunityTriggerHandler'</span>);<br />
  }<br />
  <br />
  <span class="hljs-function"><span class="hljs-keyword">public</span> override <span class="hljs-keyword">void</span> <span class="hljs-title">beforeUpdate</span><span class="hljs-params">()</span> </span>{<br />
    <span class="hljs-keyword">for</span>(Opportunity o : (List&lt;Opportunity&gt;) Trigger.new) {<br />
      <span class="hljs-comment">/* do something */</span><br />
    }<br />
  }<br />
  <br />
  <span class="hljs-comment">/* add overrides for other contexts */</span><br />
}<br />
</code></pre>
-->
<p class="has-line-data" data-line-start="55" data-line-end="56">
	<strong>Note:</strong> When referencing the Trigger static maps within a class, SObjects are returned versus SObject subclasses like Opportunity, Account, etc. This means that
	you must cast when you reference them in your trigger handler. You could do this in your constructor if you wanted. Technically, you only need to cast for oldMap and newMap, but
	for completeness, I encourage casting Trigger.new and Trigger.old as well.
</p>
<pre><code class="has-line-data" data-line-start="58" data-line-end="72" class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpportunityTriggerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TriggerHandler</span> </span>{<br />
  <span class="hljs-keyword">private</span> List&lt;Opportunity&gt; newRecords;<br />
  <span class="hljs-keyword">private</span> Map&lt;Id, Opportunity&gt; newRecordsMap;<br />
  <br />
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OpportunityTriggerHandler</span><span class="hljs-params">()</span></span>{<br />
    <span class="hljs-comment">/* Optional Constructor overload - better performance */</span><br />
    <span class="hljs-keyword">super</span>(<span class="hljs-string">'OpportunityTriggerHandler'</span>);<br />
    <span class="hljs-keyword">this</span>.newRecords = (List&lt;Opportunity&gt;) Trigger.new;<br />
    <span class="hljs-keyword">this</span>.newRecordsMap = (Map&lt;Id, Opportunity&gt;) Trigger.newMap;<br />
  }<br />
  <br />
  <span class="hljs-function"><span class="hljs-keyword">public</span> override <span class="hljs-keyword">void</span> <span class="hljs-title">beforeUpdate</span><span class="hljs-params">()</span> </span>{<br />
    <span class="hljs-keyword">for</span>(Opportunity o : newRecords) {<br />
      <span class="hljs-comment">/* do something */</span><br />
    }<br />
  }<br />
  <br />
  <span class="hljs-function"><span class="hljs-keyword">public</span> override <span class="hljs-keyword">void</span> <span class="hljs-title">afterUpdate</span><span class="hljs-params">()</span> </span>{<br />
    <span class="hljs-comment">/* do something */</span><br />
  }<br />
  <span class="hljs-comment">/* add overrides for other contexts */</span><br />
}<br />
</code></pre>
<p class="has-line-data" data-line-start="73" data-line-end="74">
	To use the trigger handler, you only need to construct an instance of your trigger handler within the trigger handler itself and call the <code>run()</code> method. Here is an
	example of the Opportunity trigger.
</p>
<pre><code class="has-line-data" data-line-start="76" data-line-end="80" class="language-java"><span class="hljs-function">trigger OpportunityTrigger on <span class="hljs-title">Opportunity</span> <span class="hljs-params">(before insert, after update)</span> </span>{<br />
  <span class="hljs-keyword">new</span> OpportunityTriggerHandler().run();<br />
}<br />
</code></pre>
<h2 class="code-line" data-line-start="81" data-line-end="82"><a id="Cool_Stuff_81"></a>Cool Stuff</h2>
<h3 class="code-line" data-line-start="83" data-line-end="84"><a id="Max_Loop_Count_83"></a>Max Loop Count</h3>
<p class="has-line-data" data-line-start="85" data-line-end="86">
	To prevent recursion, you can set a max loop count for Trigger Handler. If this max is exceeded, and exception will be thrown. A great use case is when you want to ensure that
	your trigger runs once and only once within a single execution. Example:
</p>
<pre><code class="has-line-data" data-line-start="88" data-line-end="104" class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpportunityTriggerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TriggerHandler</span> </span>{

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OpportunityTriggerHandler</span><span class="hljs-params">()</span></span>{<br />
    <span class="hljs-keyword">super</span>(<span class="hljs-string">'OpportunityTriggerHandler'</span>);<br />
    <span class="hljs-keyword">this</span>.setMaxLoopCount(<span class="hljs-number">1</span>);<br />
  }<br />

  <span class="hljs-function"><span class="hljs-keyword">public</span> override <span class="hljs-keyword">void</span> <span class="hljs-title">afterUpdate</span><span class="hljs-params">()</span> </span>{<br />
    List&lt;Opportunity&gt; opps = [SELECT Id FROM Opportunity WHERE Id IN :Trigger.newMap.keySet()];<br />
    update opps;<br />
  }<br />
}<br />
</code></pre>
<h3 class="code-line" data-line-start="105" data-line-end="106"><a id="Bypass_API_105"></a>Bypass API</h3>
<p class="has-line-data" data-line-start="107" data-line-end="108">What if you want to tell other trigger handlers to halt execution? That’s easy with the bypass api:</p>
<pre><code class="has-line-data" data-line-start="110" data-line-end="136" class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpportunityTriggerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TriggerHandler</span> </span>{<br />
	<br />
  <span class="hljs-comment">/* Optional Constructor - better performance */</span><br />
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OpportunityTriggerHandler</span><span class="hljs-params">()</span></span>{<br />
    <span class="hljs-keyword">super</span>(<span class="hljs-string">'OpportunityTriggerHandler'</span>);<br />
  }<br />
  <br />
  <span class="hljs-function"><span class="hljs-keyword">public</span> override <span class="hljs-keyword">void</span> <span class="hljs-title">afterUpdate</span><span class="hljs-params">()</span> </span>{<br />
    List&lt;Opportunity&gt; opps = [SELECT Id, AccountId FROM Opportunity WHERE Id IN :Trigger.newMap.keySet()];<br />
	<br />
    Account acc = [SELECT Id, Name FROM Account WHERE Id = :opps.get(<span class="hljs-number">0</span>).AccountId];<br />
	<br />
    TriggerHandler.bypass(<span class="hljs-string">'AccountTriggerHandler'</span>);<br />
	<br />
    acc.Name = <span class="hljs-string">'No Trigger'</span>;<br />
    update acc; <span class="hljs-comment">/* won't invoke the AccountTriggerHandler */</span><br />
	<br />
    TriggerHandler.clearBypass(<span class="hljs-string">'AccountTriggerHandler'</span>);<br />
	<br />
    acc.Name = <span class="hljs-string">'With Trigger'</span>;<br />
    update acc; <span class="hljs-comment">/* will invoke the AccountTriggerHandler */</span><br />
	<br />
  }<br />
}<br />
</code></pre>
<p class="has-line-data" data-line-start="137" data-line-end="138">If you need to check if a handler is bypassed, use the <code>isBypassed</code> method:</p>
<pre><code class="has-line-data" data-line-start="140" data-line-end="144" class="language-java"><span class="hljs-keyword">if</span> (TriggerHandler.isBypassed(<span class="hljs-string">'AccountTriggerHandler'</span>)) {<br />
  <span class="hljs-comment">/* ... do something if the Account trigger handler is bypassed! */</span><br />
}<br />
</code></pre>
<p class="has-line-data" data-line-start="145" data-line-end="146">
	If you want to clear all bypasses for the transaction, simple use the <code>clearAllBypasses</code> method, as in:
</p>
<pre><code class="has-line-data" data-line-start="148" data-line-end="154" class="language-java"><span class="hljs-comment">/* ... done with bypasses! */</span><br />
TriggerHandler.clearAllBypasses();<br />
<span class="hljs-comment">/* ... now handlers won't be ignored! */</span><br />
</code></pre>
<h2 class="code-line" data-line-start="155" data-line-end="156"><a id="Overridable_Methods_155"></a>Overridable Methods</h2>
<p class="has-line-data" data-line-start="157" data-line-end="158">Here are all of the methods that you can override. All of the context possibilities are supported.</p>
<ul>
	<li class="has-line-data" data-line-start="159" data-line-end="160"><code>beforeInsert()</code></li>
	<li class="has-line-data" data-line-start="160" data-line-end="161"><code>beforeUpdate()</code></li>
	<li class="has-line-data" data-line-start="161" data-line-end="162"><code>beforeDelete()</code></li>
	<li class="has-line-data" data-line-start="162" data-line-end="163"><code>afterInsert()</code></li>
	<li class="has-line-data" data-line-start="163" data-line-end="164"><code>afterUpdate()</code></li>
	<li class="has-line-data" data-line-start="164" data-line-end="165"><code>afterDelete()</code></li>
	<li class="has-line-data" data-line-start="165" data-line-end="166"><code>afterUndelete()</code></li>
</ul>
